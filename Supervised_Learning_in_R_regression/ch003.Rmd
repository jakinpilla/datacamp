---
title: "ch003"
author: "Daniel_Kim"
date: '2019 12 15 '
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gdata)
library(broom)
# install.packages('sigr')
library(sigr)
```


### Catogorical Variables...

 Call str on flowers to see the types of each column

```{r, message = FALSE}
# install.packages('Sleuth3')
library(Sleuth3)
```

```{r, message = FALSE}
flowers <- case0901
flowers %>%
  mutate(Time = ifelse(Time == 1, "Late", "Early")) -> flowers
flowers %>% head
```


Use unique() to see how many possible values Time takes

```{r}
unique(flowers$Time)
```


 Build a formula to express Flowers as a function of Intensity and Time: fmla. Print it
 
```{r}
(fmla <- as.formula("Flowers ~ Intensity + Time"))
```
 
Use fmla and model.matrix to see how the data is represented for modeling

```{r}
mmat <- model.matrix(fmla, flowers)
mmat
```


 Examine the first 20 lines of flowers
 
```{r}
head(flowers, 20)
```
 

 Examine the first 20 lines of mmat

```{r}
head(mmat, 20)
```


Fit a model to predict Flowers from Intensity and Time : flower_model

```{r}
flower_model <- lm(fmla, data= flowers)
```

Use summary on mmat to remind yourself of its structure

```{r}
summary(mmat)
```

Use summary to examine flower_model 

```{r}
summary(flower_model)
```


Predict the number of flowers on each plant

```{r}
flowers$predictions <- predict(flower_model, flowers)
```


Plot predictions vs actual flowers (predictions on x-axis)

```{r}
ggplot(flowers, aes(x = predictions, y = Flowers)) + 
  geom_point() +
  geom_abline(color = "blue") 
```

### Interactions

Data alcohol loading...

```{r}
# str(case1101)
alcohol <- case1101
str(alcohol)
```

```{r}
summary(alcohol)
```


Create the formula with main effects only
Gastric : 위, Metabol : 물질대사

```{r}
(fmla_add <- Metabol ~ Gastric + Sex)
```

Create the formula with interactions
Gastric은 주요 영향 요인이지만 Sex는 아니므로 교호작용 항만 추가합니다.

```{r}
(fmla_interaction <- Metabol ~ Gastric + Gastric:Sex)
```

Fit the main effects only model

```{r}
model_add <- lm(fmla_add, data = alcohol)
```

Fit the interaction model

```{r}
model_interaction <- lm(fmla_interaction, data =  alcohol)
```

Call summary on both models and compare

```{r}
summary(model_add)
```


```{r}
summary(model_interaction)
```

Create the splitting plan for 3-fold cross validation

```{r}
set.seed(34245)  # set the seed for reproducibility
splitPlan <- kWayCrossValidation(nrow(alcohol), 3, NULL, NULL)
```


Sample code: Get cross-val predictions for main-effects only model

```{r}
alcohol$pred_add <- 0  # initialize the prediction vector
for(i in 1:3) {
  split <- splitPlan[[i]]
  model_add <- lm(fmla_add, data = alcohol[split$train, ])
  alcohol$pred_add[split$app] <- predict(model_add, newdata = alcohol[split$app, ])
}
```


Get the cross-val predictions for the model with interactions

```{r}
alcohol$pred_interaction <- 0 # initialize the prediction vector
for(i in 1:3) {
  split <- splitPlan[[i]]
  model_interaction <- lm(fmla_interaction, data = alcohol[split$train, ])
  alcohol$pred_interaction[split$app] <- predict(model_interaction, newdata = alcohol[split$app, ])
}
```


Get RMSE

```{r}
alcohol %>% 
  gather(key = modeltype, value = pred, pred_add, pred_interaction) %>%
  mutate(residuals = Metabol - pred) %>%      
  group_by(modeltype) %>%
  summarize(rmse = sqrt(mean(residuals^2))) # residuals^2 에 유의할 것...
```

### Transforming the response before modeling...

```{r}
load('./data/Income.RData')
```



# Examine the data: generate the summaries for the groups large and small:
fdata %>% 
    group_by(label) %>%     # group by small/large purchases
    summarize(min  = ___,   # min of y
              mean = ___,   # mean of y
              max  = ___)   # max of y

# Fill in the blanks to add error columns
fdata2 <- fdata %>% 
         group_by(label) %>%       # group by label
           mutate(residual = ___,  # Residual
                  relerr   = ___)  # Relative error

# Compare the rmse and rmse.rel of the large and small groups:
fdata2 %>% 
  group_by(label) %>% 
  summarize(rmse     = ___,   # RMSE
            rmse.rel = ___)   # Root mean squared relative error
            
# Plot the predictions for both groups of purchases
ggplot(fdata2, aes(x = pred, y = y, color = label)) + 
  geom_point() + 
  geom_abline() + 
  facet_wrap(~ label, ncol = 1, scales = "free") + 
  ggtitle("Outcome vs prediction")